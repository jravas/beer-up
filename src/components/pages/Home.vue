<template>
  <div class="home-wrap">
    <div class="home-container">
      <section>
        <h2>Beer</h2>
        <!-- items sorting component -->
        <beer-sort v-if="sortData.length" :data="sortData"></beer-sort>
        <div class="items-container" id="items-container-scroll">
          <!-- listing items with beer item component -->
          <beer-item
            v-for="(item, index) in items"
            :key="index"
            :data="item"
            @modal="openModal(item)"
            @favorite="addToFavorites(item)">
          </beer-item>
        </div>
        <beer-pagination
          class="mobile-pagination"
          v-if="pagination"
          :data="{page: page, number: items.length}"
          @nextPage="nextPage"
          @prevPage="prevPage">
        </beer-pagination>
      </section>
      <aside>
        <!-- crate sidebar -->
        <beer-crate></beer-crate>
      </aside>
      <!-- modal with beer info -->
      <beer-modal
        v-if="modalVisible"
        :data="modalData"
        @close="closeModal"
        @favorite="addToFavorites(modalData)"
        @crate="addToCrate(modalData)">
      </beer-modal>
    </div>
    <!-- pagination -->
    <beer-pagination
      class="desktop-pagination"
      v-if="pagination"
      :data="{page: page, number: items.length}"
      @nextPage="nextPage"
      @prevPage="prevPage">
    </beer-pagination>
  </div>
</template>

<script>
import BeerItem from '@/components/layout/BeerItem'
import BeerModal from '@/components/layout/BeerModal'
import BeerPagination from '@/components/layout/BeerPagination'
import BeerSort from '@/components/layout/BeerSort'
import BeerCrate from '@/components/layout/BeerCrate'
import fakeItems from '../../data/items.js'
export default {
  name: 'Home',
  components: {
    BeerItem,
    BeerModal,
    BeerPagination,
    BeerCrate,
    BeerSort
  },
  data () {
    return {
      modalData: null,
      modalVisible: false,
      page: 1,
      items: fakeItems.fakeItems,
      pagination: false,
      sortData: [],
      loaded: false
    }
  },
  computed: {
    lastPage () {
      // if there are less than 20 items current page is last
      return this.items.length === 20
    },
    body () {
      // geting body elment for setting overflow when modal active
      return document.getElementsByTagName('body')[0]
    }
  },
  methods: {
    getBeer (page) {
      this.loaded = false
      this.$Progress.start()
      var that = this
      this.$store.dispatch('fetchItems', page).then(() => {
        // pass data to sortin component
        this.itemsLength = that.$store.state.items.length
        that.sortData = that.$store.state.items
        that.items = that.$store.state.items
        that.loaded = true
        that.pagination = true
        that.$Progress.finish()
      })
    },
    openModal (item) {
      this.modalData = item
      this.modalVisible = !this.modalVisible
      this.body.style.overflow = 'hidden'
    },
    closeModal () {
      this.modalVisible = !this.modalVisible
      this.body.style.overflow = 'auto'
    },
    addToFavorites (data) {
      // add item to favorites
      data.favorites = !data.favorites
      this.$store.dispatch('addToFavorites', data)
    },
    addToCrate (data) {
      // add item to crateÂ¸
      this.$store.dispatch('addToCrate', data)
      data.inCrate++
    },
    nextPage () {
      // prevent nex page button if items aren't loaded
      if (this.loaded) {
        this.page++
        this.getBeer(this.page)
      }
    },
    prevPage () {
      this.page--
      this.getBeer(this.page)
    }
  },
  mounted () {
    this.getBeer(this.page)
    // attempt of infinite scroll implementation
    // load data on moblie when user scrolls
    // if (window) {
    //   window.addEventListener('touchmove', () => {
    //     let screenWidth = document.getElementById('items-container-scroll').getBoundingClientRect().width
    //     let scrollLeft = document.getElementById('items-container-scroll').scrollLeft
    //     let scrollWidth = document.getElementById('items-container-scroll').scrollWidth
    //     this.$store.commit('mobileFalse')
    //     console.log(this.$store.state.mobileLoaded)
    //     if (scrollLeft + screenWidth > scrollWidth) {
    //       console.log('no more items')
    //     }
    //   })
    // }
  }
}
</script>
